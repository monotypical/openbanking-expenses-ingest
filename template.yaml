AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: >
  openbanking-expenses-ingest

  Exports expenses to google sheets using OpenBanking via the GoCardless Bank Account Data API

Parameters:
  BankName:
    Type: String
    Description: The name of the bank institution to use to authenticate with
    Default: Starling Bank
  BankCountry:
    Type: String
    Description: The country of the bank instutution to use
    Default: GB
  RequisitionNotificationAddress:
    Type: String
    Description: The email address to notify when user action is needed to generate a requisition

Resources:
  UpdateApiCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Renews or refreshes the access token for the GoCardless Bank Account Data API where necessary
      CodeUri: functions/update-api-credentials/
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: index.handler
      Timeout: 30
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: 'GoCardless/*'
        - KMSDecryptPolicy:
            KeyId: !Ref KmsKey
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: 'es2020'
        EntryPoints:
          - index.ts
  
  UpdateRequisitionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Renews or refreshes the requisition for the GoCardless Bank Account Data API where necessary
      CodeUri: functions/update-requisition/
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: index.handler
      Timeout: 30
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref RequisitionTable
        - DynamoDBWritePolicy:
            TableName: !Ref RequisitionTable
        - KMSDecryptPolicy:
            KeyId: !Ref KmsKey
        - KMSEncryptPolicy:
            KeyId: !Ref KmsKey
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt RequisitionSnsTopic.TopicName
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - kms:GenerateDataKey
              Resource: !GetAtt KmsKey.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: 'es2020'
        EntryPoints:
          - index.ts

  HandleRequisitionResponseFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Handles the requisition complete response
      CodeUri: functions/handle-requisition-response/
      Environment:
        Variables:
          REQUISITIONS_TABLE_NAME: !Ref RequisitionTable
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: index.handler
      Timeout: 30
      Events:
        RequisitionComplete:
          Type: Api
          Properties:
            Path: /requisition-complete
            Method: GET
            RestApiId: !Ref RequisitionApi
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref RequisitionTable
        - DynamoDBWritePolicy:
            TableName: !Ref RequisitionTable
        - KMSEncryptPolicy:
            KeyId: !Ref KmsKey
        - KMSDecryptPolicy:
            KeyId: !Ref KmsKey
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
              Resource: !Sub arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:*
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: 'es2020'
        EntryPoints:
          - index.ts
  
  IngestSharedExpensesStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/openbanking-expenses-ingest.json
      DefinitionSubstitutions:
        UpdateApiCredentialsFunctionARN: !Ref UpdateApiCredentialsFunction
        UpdateRequisitionFunctionARN: !Ref UpdateRequisitionFunction
        SsmKeyId: !Ref KmsKey
        SecretIdParamName: /GoCardless/Secret-Id
        SecretKeyParamName: /GoCardless/Secret-Key
        AccessTokenParamName: /GoCardless/Access-Token
        AccessTokenExpiresParamName: /GoCardless/Access-Token-Expires
        RefreshTokenParamName: /GoCardless/Refresh-Token
        RefreshTokenExpiresParamName: /GoCardless/Refresh-Token-Expires
        RequisitionReferenceParamName: /GoCardless/Requisition-Reference
        BankName: !Ref BankName
        BankCountry: !Ref BankCountry
        RequisitionTableName: !Ref RequisitionTable
        RequisitionNotificationTopicARN: !Ref RequisitionSnsTopic
        RequisitionCompleteEndpointUrl: !Sub
          - "https://${ApiId}.execute-api.${AWS::Region}.amazonaws.com/v1/requisition-complete"
          - ApiId: !Ref RequisitionApi
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref UpdateApiCredentialsFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref UpdateRequisitionFunction
        - SSMParameterReadPolicy:
            ParameterName: 'GoCardless/*'
        - KMSDecryptPolicy:
            KeyId: !Ref KmsKey
        - KMSEncryptPolicy:
            KeyId: !Ref KmsKey
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - ssm:PutParameter
              Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/GoCardless/*'
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
              Resource: !Sub arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:*

  RequisitionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: GoCardless-Requisition
      AttributeDefinitions:
        - AttributeName: reference
          AttributeType: S
      KeySchema:
        - AttributeName: reference
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        KMSMasterKeyId: !Ref KmsKey
        SSEEnabled: true
        SSEType: KMS
      TimeToLiveSpecification:
        AttributeName: expires
        Enabled: true
  
  RequisitionApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: GoCardless Requisition API
      Description: "API to update the status of requisitions when they have been authorized by the end user"
      StageName: v1
      MethodSettings:
        - ResourcePath: /requisition-complete
          HttpMethod: GET
  
  RequisitionSnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: GoCardless-Bank-Account-Data-Agreement
      DisplayName: GoCardless Bank Account API agreement notification
      KmsMasterKeyId: !Ref KmsKey
      Subscription:
        - Endpoint: !Ref RequisitionNotificationAddress
          Protocol: email

  KmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: The key used to encrypt sensitive information related to the openbanking-expenses-ingest service
      KeyPolicy:
        Version: '2012-10-17'
        Id: openbanking-expenses-ingest-key-policy
        Statement:
          - Sid: Enable Root User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
  
  KmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/Openbanking-Expenses-Ingest
      TargetKeyId: !Ref KmsKey
